import json
import logging
from flask import Flask, request
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters
)

# Ø®ÙˆØ§Ù†Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² ÙØ§ÛŒÙ„ config.json
with open("config.json", "r") as f:
    config = json.load(f)

TOKEN = config["TOKEN"]
ADMIN_ID = config["ADMIN_ID"]
CHANNEL_ID = config["CHANNEL_ID"]
CHANNEL_LINK = config["CHANNEL_LINK"]

CARD_NUMBER = "6219 8619 0952 136\nØ¨Ù‡ Ù†Ø§Ù…: Ù…ÛŒÙ„Ø§Ø¯"

PRODUCTS = {
    "2018": {"price": "250,000", "title": "Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ Ø³Ø§Ø®Øª 2018"},
    "2025": {"price": "200,000", "title": "Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ Ø³Ø§Ø®Øª 2025"},
    "custom": {"price": "350,000", "title": "Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ"}
}

# ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù„Ø§Ú¯
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    member = await context.bot.get_chat_member(CHANNEL_ID, user.id)

    if member.status in ["left", "kicked"]:
        btn = InlineKeyboardMarkup([[InlineKeyboardButton("Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ ğŸ“¢", url=CHANNEL_LINK)]])
        await update.message.reply_text("ğŸ‘‹ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø§Ø¨ØªØ¯Ø§ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø´Ùˆ:", reply_markup=btn)
        return

    await update.message.reply_text(
        "ğŸ“± Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardMarkup([["Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡"]], resize_keyboard=True)
    )

# Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    user_data = context.user_data

    if text == "Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡":
        await update.message.reply_text(
            "âœ… Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ø­Ø§Ù„Ø§ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:",
            reply_markup=ReplyKeyboardMarkup([
                ["ğŸ“¦ Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ 2018 - 250 ØªÙˆÙ…Ø§Ù†"],
                ["ğŸ“¦ Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ 2025 - 200 ØªÙˆÙ…Ø§Ù†"],
                ["ğŸ“ Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ - 350 ØªÙˆÙ…Ø§Ù†"]
            ], resize_keyboard=True)
        )

    elif "2018" in text:
        user_data["product"] = "2018"
        await update.message.reply_text(
            f"ğŸ”» Ù…Ø¨Ù„Øº {PRODUCTS['2018']['price']} ØªÙˆÙ…Ø§Ù† Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†:\n\n"
            f"{CARD_NUMBER}\n\nØ³Ù¾Ø³ Ø±Ø³ÛŒØ¯ Ø±Ø§ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†."
        )

    elif "2025" in text:
        user_data["product"] = "2025"
        await update.message.reply_text(
            f"ğŸ”» Ù…Ø¨Ù„Øº {PRODUCTS['2025']['price']} ØªÙˆÙ…Ø§Ù† Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†:\n\n"
            f"{CARD_NUMBER}\n\nØ³Ù¾Ø³ Ø±Ø³ÛŒØ¯ Ø±Ø§ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†."
        )

    elif "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ" in text:
        user_data["product"] = "custom"
        await update.message.reply_text(
            f"ğŸ”» Ù…Ø¨Ù„Øº {PRODUCTS['custom']['price']} ØªÙˆÙ…Ø§Ù† Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†:\n\n"
            f"{CARD_NUMBER}\n\nØ³Ù¾Ø³ Ø±Ø³ÛŒØ¯ + Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„Ø§Ø²Ù… (Ù†Ø§Ù… Ùˆ ...) Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†."
        )

    else:
        msg = f"ğŸ§¾ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² {update.effective_user.full_name} ({update.effective_user.id}):\n\n{text}"
        await context.bot.send_message(chat_id=ADMIN_ID, text=msg)
        await update.message.reply_text("âœ… Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

# Flask app Ø¨Ø±Ø§ÛŒ Webhook
app = Flask(__name__)
application = None

@app.route('/')
def index():
    return 'Ø±Ø¨Ø§Øª ÙØ¹Ø§Ù„Ù‡ âœ…'

@app.route(f'/{TOKEN}', methods=['POST'])
async def webhook():
    if request.method == "POST":
        update = Update.de_json(request.get_json(force=True), application.bot)
        await application.process_update(update)
        return 'ok'

# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø±Ø¨Ø§Øª
async def main():
    global application
    application = ApplicationBuilder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, message_handler))

    # ØªÙ†Ø¸ÛŒÙ… Webhook Ø¨Ø±Ø§ÛŒ render
    await application.bot.set_webhook(f"https://appleid035.onrender.com/{TOKEN}")
    print("âœ… Webhook ÙØ¹Ø§Ù„ Ø´Ø¯.")

    return application

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
    app.run(host="0.0.0.0", port=10000)
