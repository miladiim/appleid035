from flask import Flask, request
import telebot
import os
import json
import datetime

API_TOKEN = '8255151341:AAGFwWdSGnkoEVrTOej0jaNUco-DmgKlbCs'
ADMIN_ID = 368422936
CARD_NUMBER = '6037-9911-9073-3544'

bot = telebot.TeleBot(API_TOKEN)
app = Flask(__name__)

USERS_FILE = 'users.json'
PAYMENTS_FILE = 'payments.json'
SUPPORT_FILE = 'support.json'

PRODUCTS = [
    {"id": 1, "name": "Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ 2018", "price": 250000},
    {"id": 2, "name": "Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ 2025", "price": 200000},
    {"id": 3, "name": "Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ Ø´Ù…Ø§", "price": 300000},
]

def load_data(filename, default):
    if not os.path.exists(filename):
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(default, f, ensure_ascii=False, indent=2)
    with open(filename, 'r', encoding='utf-8') as f:
        try:
            return json.load(f)
        except:
            return default

def save_data(filename, data):
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def get_user(user_id):
    users = load_data(USERS_FILE, {})
    return users.get(str(user_id))

def set_user(user_id, user):
    users = load_data(USERS_FILE, {})
    users[str(user_id)] = user
    save_data(USERS_FILE, users)

def add_payment(payment):
    payments = load_data(PAYMENTS_FILE, [])
    payments.append(payment)
    save_data(PAYMENTS_FILE, payments)

def get_payments():
    return load_data(PAYMENTS_FILE, [])

def add_support(support):
    supports = load_data(SUPPORT_FILE, [])
    supports.append(support)
    save_data(SUPPORT_FILE, supports)

def get_supports():
    return load_data(SUPPORT_FILE, [])

def send_main_menu(chat_id):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.row(
        telebot.types.KeyboardButton("ğŸ›’ Ø®Ø±ÛŒØ¯ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ"),
        telebot.types.KeyboardButton("ğŸ“¨ ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ")
    )
    markup.row(
        telebot.types.KeyboardButton("ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ"),
        telebot.types.KeyboardButton("ğŸ’³ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨")
    )
    bot.send_message(chat_id, "ğŸ“‹ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:", reply_markup=markup)

@app.route('/', methods=['GET'])
def index():
    return 'Bot is running'

@app.route('/webhook', methods=['POST'])
def webhook():
    update = telebot.types.Update.de_json(request.get_data(as_text=True))
    bot.process_new_updates([update])
    return 'ok'

@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    user = get_user(user_id)
    if not user:
        set_user(user_id, {
            "id": user_id,
            "name": message.from_user.first_name,
            "mobile": "",
            "joined": str(datetime.datetime.now()),
            "wallet": 0,
            "purchases": 0
        })
    user = get_user(user_id)
    if not user.get("mobile"):
        markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup.add(telebot.types.KeyboardButton("ğŸ“± Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„", request_contact=True))
        bot.send_message(user_id, "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:", reply_markup=markup)
        return
    send_main_menu(user_id)

@bot.message_handler(content_types=['contact'])
def handle_contact(message):
    user_id = message.from_user.id
    mobile = message.contact.phone_number
    user = get_user(user_id)
    if user:
        user["mobile"] = mobile
        set_user(user_id, user)
        bot.send_message(user_id, "âœ… Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.")
        send_main_menu(user_id)

@bot.message_handler(func=lambda m: m.text == "ğŸ›’ Ø®Ø±ÛŒØ¯ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ")
def buy_appleid(message):
    for p in PRODUCTS:
        markup = telebot.types.InlineKeyboardMarkup()
        markup.add(
            telebot.types.InlineKeyboardButton("ğŸ’³ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª", callback_data=f"pay_card_{p['id']}"),
            telebot.types.InlineKeyboardButton("ğŸ’° Ø®Ø±ÛŒØ¯ Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„", callback_data=f"pay_wallet_{p['id']}")
        )
        text = f"ğŸ”¹ {p['name']}\nğŸ’° Ù‚ÛŒÙ…Øª: {p['price']:,} ØªÙˆÙ…Ø§Ù†\n\nØ±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:"
        bot.send_message(message.chat.id, text, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith("pay_card_"))
def pay_card(call):
    product_id = int(call.data.split("_")[2])
    product = next((p for p in PRODUCTS if p["id"] == product_id), None)
    if not product:
        bot.answer_callback_query(call.id, "Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯")
        return
    text = (
        f"ğŸ’³ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ {product['name']} Ø¨Ù‡ Ù…Ø¨Ù„Øº {product['price']:,} ØªÙˆÙ…Ø§Ù†:\n"
        f"Û±. Ù…Ø¨Ù„Øº Ø±Ø§ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯:\n\n{CARD_NUMBER}\n\n"
        f"Û². Ø³Ù¾Ø³ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯."
    )
    bot.send_message(call.message.chat.id, text)
    bot.register_next_step_handler_by_chat_id(call.message.chat.id, lambda m: receive_receipt(m, product))

def receive_receipt(message, product):
    if message.photo:
        payment = {
            "user_id": message.from_user.id,
            "name": message.from_user.first_name,
            "product": product["name"],
            "amount": product["price"],
            "type": "buy",
            "status": "pending",
            "msg_id": None
        }
        add_payment(payment)
        caption = (
            f"ğŸ†• Ø±Ø³ÛŒØ¯ Ø®Ø±ÛŒØ¯\n"
            f"Ú©Ø§Ø±Ø¨Ø±: {message.from_user.first_name}\n"
            f"Ù…Ø­ØµÙˆÙ„: {product['name']}\n"
            f"Ù…Ø¨Ù„Øº: {product['price']:,} ØªÙˆÙ…Ø§Ù†\n"
            f"Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒØŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯."
        )
        markup = telebot.types.InlineKeyboardMarkup()
        markup.add(telebot.types.InlineKeyboardButton("Ù¾Ø§Ø³Ø®", callback_data=f"reply_buy_{message.from_user.id}"))
        photo_id = message.photo[-1].file_id
        msg = bot.send_photo(ADMIN_ID, photo_id, caption=caption, reply_markup=markup)
        payment["msg_id"] = msg.message_id
        payments = get_payments()
        payments[-1]["msg_id"] = msg.message_id
        save_data(PAYMENTS_FILE, payments)
        bot.send_message(message.chat.id, "âœ… Ø±Ø³ÛŒØ¯ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ØŒ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± Ø¨Ø§Ø´ÛŒØ¯.")
    else:
        bot.send_message(message.chat.id, "âŒ Ù„Ø·ÙØ§Ù‹ ØªØµÙˆÛŒØ± Ø±Ø³ÛŒØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")

@bot.callback_query_handler(func=lambda call: call.data.startswith("reply_buy_"))
def reply_to_buy(call):
    user_id = int(call.data.split("_")[2])
    bot.send_message(call.message.chat.id, "Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¬Ù‡Øª Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    bot.register_next_step_handler_by_chat_id(call.message.chat.id, lambda m: admin_reply_buy(m, user_id))

def admin_reply_buy(message, user_id):
    bot.send_message(user_id, f"ğŸ“© Ù¾Ø§Ø³Ø® Ù…Ø¯ÛŒØ±: {message.text}")
    bot.send_message(message.chat.id, "âœ… Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

@bot.callback_query_handler(func=lambda call: call.data.startswith("pay_wallet_"))
def pay_wallet(call):
    product_id = int(call.data.split("_")[2])
    product = next((p for p in PRODUCTS if p["id"] == product_id), None)
    user = get_user(call.from_user.id)
    if not product:
        bot.answer_callback_query(call.id, "Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯")
        return
    if user["wallet"] >= product["price"]:
        user["wallet"] -= product["price"]
        user["purchases"] += 1
        set_user(call.from_user.id, user)
        bot.send_message(call.message.chat.id, f"âœ… Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.\n\nÙ…Ø­ØµÙˆÙ„: {product['name']}")
        bot.send_message(ADMIN_ID, f"ğŸ”” Ø®Ø±ÛŒØ¯ Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„ ØªÙˆØ³Ø· {user['name']}\nÙ…Ø­ØµÙˆÙ„: {product['name']}\nÙ…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {user['wallet']:,} ØªÙˆÙ…Ø§Ù†")
    else:
        bot.send_message(call.message.chat.id, "âŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.")

@bot.message_handler(func=lambda m: m.text == "ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ")
def show_profile(message):
    user = get_user(message.from_user.id)
    if user:
        bot.send_message(message.chat.id, f"ğŸ‘¤ Ù†Ø§Ù…: {user['name']}\nğŸ“± Ø´Ù…Ø§Ø±Ù‡: {user['mobile']}\nğŸ“† ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª: {user['joined']}\nğŸ›’ ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯: {user['purchases']}\nğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„: {user['wallet']:,} ØªÙˆÙ…Ø§Ù†")
    else:
        bot.send_message(message.chat.id, "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯.")

@bot.message_handler(func=lambda m: m.text == "ğŸ“¨ ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ")
def support_ticket(message):
    bot.send_message(message.chat.id, "Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
    bot.register_next_step_handler(message, handle_support)

def handle_support(message):
    user = get_user(message.from_user.id)
    ticket = {
        "user_id": message.from_user.id,
        "name": user["name"],
        "text": message.text,
        "status": "pending",
        "msg_id": None
    }
    add_support(ticket)
    caption = (
        f"ğŸ« ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n"
        f"Ú©Ø§Ø±Ø¨Ø±: {user['name']}\n"
        f"Ù¾ÛŒØ§Ù…: {message.text}\n"
        f"Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒØŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯."
    )
    markup = telebot.types.InlineKeyboardMarkup()
    markup.add(telebot.types.InlineKeyboardButton("Ù¾Ø§Ø³Ø®", callback_data=f"reply_ticket_{message.from_user.id}"))
    msg = bot.send_message(ADMIN_ID, caption, reply_markup=markup)
    ticket["msg_id"] = msg.message_id
    supports = get_supports()
    supports[-1]["msg_id"] = msg.message_id
    save_data(SUPPORT_FILE, supports)
    bot.send_message(message.chat.id, "âœ… Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

@bot.callback_query_handler(func=lambda call: call.data.startswith("reply_ticket_"))
def reply_to_ticket(call):
    user_id = int(call.data.split("_")[2])
    bot.send_message(call.message.chat.id, "Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    bot.register_next_step_handler_by_chat_id(call.message.chat.id, lambda m: admin_reply_ticket(m, user_id))

def admin_reply_ticket(message, user_id):
    bot.send_message(user_id, f"ğŸ“© Ù¾Ø§Ø³Ø® Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: {message.text}")
    bot.send_message(message.chat.id, "âœ… Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

@bot.message_handler(func=lambda m: m.text == "ğŸ’³ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨")
def charge_account(message):
    bot.send_message(message.chat.id, f"Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨ØŒ Ù…Ø¨Ù„Øº Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ø±Ø¯Ù‡ Ùˆ Ø±Ø³ÛŒØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n{CARD_NUMBER}")
    bot.register_next_step_handler(message, receive_charge_receipt)

def receive_charge_receipt(message):
    if message.photo:
        user = get_user(message.from_user.id)
        payment = {
            "user_id": message.from_user.id,
            "name": user["name"],
            "type": "charge",
            "status": "pending",
            "msg_id": None
        }
        add_payment(payment)
        markup = telebot.types.InlineKeyboardMarkup()
        markup.add(telebot.types.InlineKeyboardButton("Ù¾Ø§Ø³Ø®", callback_data=f"reply_charge_{message.from_user.id}"))
        photo_id = message.photo[-1].file_id
        msg = bot.send_photo(ADMIN_ID, photo_id, caption=f"ğŸ’¸ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨ Ø§Ø² {user['name']}\nØ¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.", reply_markup=markup)
        payment["msg_id"] = msg.message_id
        payments = get_payments()
        payments[-1]["msg_id"] = msg.message_id
        save_data(PAYMENTS_FILE, payments)
        bot.send_message(message.chat.id, "âœ… Ø±Ø³ÛŒØ¯ Ø´Ø§Ø±Ú˜ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ùˆ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± Ø¨Ø§Ø´ÛŒØ¯.")
    else:
        bot.send_message(message.chat.id, "âŒ Ù„Ø·ÙØ§Ù‹ ØªØµÙˆÛŒØ± Ø±Ø³ÛŒØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.")

@bot.callback_query_handler(func=lambda call: call.data.startswith("reply_charge_"))
def reply_to_charge(call):
    user_id = int(call.data.split("_")[2])
    bot.send_message(call.message.chat.id, "Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (ÙÙ‚Ø· Ø¹Ø¯Ø¯):")
    bot.register_next_step_handler_by_chat_id(call.message.chat.id, lambda m: admin_charge_user(m, user_id))

def admin_charge_user(message, user_id):
    if message.text.isdigit():
        user = get_user(user_id)
        user["wallet"] += int(message.text)
        set_user(user_id, user)
        bot.send_message(user_id, f"ğŸ’° Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ù‡ Ù…Ø¨Ù„Øº {int(message.text):,} ØªÙˆÙ…Ø§Ù† Ø´Ø§Ø±Ú˜ Ø´Ø¯.")
        bot.send_message(message.chat.id, "âœ… Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Ø¨Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.")
    else:
        bot.send_message(message.chat.id, "Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ù…Ø¨Ù„Øº Ø±Ø§ Ø¨Ù‡ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")

@bot.message_handler(func=lambda m: True)
def fallback(message):
    send_main_menu(message.chat.id)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)
