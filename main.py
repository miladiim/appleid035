from flask import Flask, request
import telebot
import time
import threading
import json
import os

API_TOKEN = '8255151341:AAGFwWdSGnkoEVrTOej0jaNUco-DmgKlbCs'
CHANNEL_ID = -1002891641618
ADMIN_ID = 368422936

bot = telebot.TeleBot(API_TOKEN)
app = Flask(__name__)

APPLEID_FILE = 'apple_ids.json'

def load_apple_ids():
    if not os.path.exists(APPLEID_FILE):
        with open(APPLEID_FILE, 'w', encoding='utf-8') as f:
            json.dump([], f)
    with open(APPLEID_FILE, 'r', encoding='utf-8') as f:
        return json.load(f)

def save_apple_ids(data):
    with open(APPLEID_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

users = {}

@app.route('/', methods=['GET'])
def index():
    return 'Bot is running'

@app.route('/webhook', methods=['POST'])
def webhook():
    update = telebot.types.Update.de_json(request.get_data(as_text=True))
    bot.process_new_updates([update])
    return 'ok'

def send_main_menu(chat_id):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add(
        telebot.types.KeyboardButton('ğŸ›’ Ø®Ø±ÛŒØ¯ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ'),
        telebot.types.KeyboardButton('ğŸ« ØªÛŒÚ©Øª Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ')
    )
    bot.send_message(chat_id, "ğŸ“‹ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:", reply_markup=markup)

@bot.message_handler(commands=['start'])
def send_welcome(message):
    chat_id = message.chat.id
    user_id = message.from_user.id
    # Ø§Ú¯Ø± Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù‚Ø¨Ù„Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
    if user_id in users and "phone" in users[user_id]:
        send_main_menu(chat_id)
    else:
        # Ø¯Ú©Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ (request_contact=True)
        markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        btn = telebot.types.KeyboardButton('ğŸ“± Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„', request_contact=True)
        markup.add(btn)
        bot.send_message(chat_id, "Ø³Ù„Ø§Ù… ğŸ‘‹ Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„Øª Ø±Ùˆ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†:", reply_markup=markup)

@bot.message_handler(content_types=['contact'])
def handle_contact(message):
    user_id = message.from_user.id
    phone = message.contact.phone_number
    users[user_id] = {"phone": phone, "active": False, "timestamp": int(time.time())}
    bot.send_message(ADMIN_ID, f"ğŸ“¥ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯\nØ¢ÛŒØ¯ÛŒ: {user_id}\nØ´Ù…Ø§Ø±Ù‡: {phone}")
    # Ø§Ø±Ø³Ø§Ù„ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø¯ÙˆÙ† Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ø­Ø°Ù Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„)
    send_main_menu(message.chat.id)

# Ø­Ø°Ù handler Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¯Ø³ØªÛŒ (func=lambda m: m.text == 'ğŸ“± Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„') Ú©Ù‡ Ù‚Ø¨Ù„Ø§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª
# ØªØ§ Ú©Ø§Ø±Ø¨Ø± ÙÙ‚Ø· Ø¨ØªÙˆØ§Ù†Ø¯ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡ØŒ Ø´Ù…Ø§Ø±Ù‡ Ø±Ø§ Ø¨ÙØ±Ø³ØªØ¯ Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø³ØªÛŒ ØªØ§ÛŒÙ¾ Ù†Ú©Ù†Ø¯.

# Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒØŒ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±

@bot.message_handler(func=lambda m: m.text == 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ')
def show_appleid_menu(message):
    markup = telebot.types.InlineKeyboardMarkup(row_width=1)
    markup.add(
        telebot.types.InlineKeyboardButton("ğŸ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ Ø³Ø§Ø®Øª 2018 Ø¢Ù…Ø±ÛŒÚ©Ø§ (250,000 ØªÙˆÙ…Ø§Ù†)", callback_data='buy_2018'),
        telebot.types.InlineKeyboardButton("ğŸ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ Ø³Ø§Ø®Øª 2025 Ø¢Ù…Ø±ÛŒÚ©Ø§ (200,000 ØªÙˆÙ…Ø§Ù†)", callback_data='buy_2025'),
        telebot.types.InlineKeyboardButton("ğŸ” Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ (350,000 ØªÙˆÙ…Ø§Ù†)", callback_data='buy_personal')
    )
    bot.send_message(message.chat.id, "Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=markup)

# Ø¨Ù‚ÛŒÙ‡â€ŒÛŒ Ú©Ø¯Ù‡Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø«Ù„ Ø´Ù…Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯

@bot.message_handler(func=lambda m: m.text == 'ğŸ« ØªÛŒÚ©Øª Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ')
def support_ticket(message):
    user_id = message.from_user.id
    bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯. Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ØŒ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø®ÙˆØ§Ù‡Ø¯ Ø±Ø³ÛŒØ¯.")

@bot.message_handler(func=lambda m: m.reply_to_message and m.reply_to_message.from_user.id == ADMIN_ID)
def admin_reply(message):
    if message.from_user.id != ADMIN_ID:
        return
    if not message.reply_to_message or not message.reply_to_message.text:
        return
    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„ÛŒ (Ø®Ø· Ø§ÙˆÙ„)
    lines = message.reply_to_message.text.split('\n')
    if len(lines) < 2:
        return
    try:
        user_line = lines[0]
        user_id = int(user_line.split()[-1])
        bot.send_message(user_id, f"ğŸ’¬ Ù¾Ø§Ø³Ø® Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:\n{message.text}")
    except:
        pass

@bot.message_handler(func=lambda m: m.text and m.text not in ['ğŸ« ØªÛŒÚ©Øª Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ'])
def forward_ticket(message):
    if message.from_user.id == ADMIN_ID:
        return
    user_id = message.from_user.id
    bot.send_message(ADMIN_ID, f"ğŸ“© Ù¾ÛŒØ§Ù… Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id}:\n{message.text}")
    bot.send_message(user_id, "âœ… Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

def run_bot():
    bot.remove_webhook()
    bot.set_webhook(url='https://appleid035.onrender.com/webhook')  # â† Ø¯Ø§Ù…Ù†Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ø±ÙˆÛŒ Render
    app.run(host='0.0.0.0', port=5000)

if __name__ == '__main__':
    run_bot()

    
