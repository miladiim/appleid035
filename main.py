import logging
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# ---------------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ----------------
TOKEN = "8255151341:AAGFwWdSGnkoEVrTOej0jaNUco-DmgKlbCs"  # ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª
CHANNEL_ID = -1002891641618  # Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ù†Ø§Ù„ VIP
ADMIN_ID = 368422936  # Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø§Ø¯Ù…ÛŒÙ† (Ù…ÛŒÙ„Ø§Ø¯)

CARD_NUMBER = """6219 8619 0952 1360
Ø¨Ù‡ Ù†Ø§Ù…: Ù…ÛŒÙ„Ø§Ø¯ Ù…Ø­Ø¨ÙˆØ¨ÛŒØ§Ù†"""

PRODUCTS = {
    "2018": {"price": "250,000", "title": "Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ Ø³Ø§Ø®Øª 2018"},
    "2025": {"price": "200,000", "title": "Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ Ø³Ø§Ø®Øª 2025"},
    "custom": {"price": "350,000", "title": "Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ"}
}

# ---------------- Ù„Ø§Ú¯ ----------------
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ---------------- /start ----------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    member = await context.bot.get_chat_member(CHANNEL_ID, user.id)

    if member.status in ["left", "kicked"]:
        btn = InlineKeyboardMarkup(
            [[InlineKeyboardButton("Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ ğŸ“¢", url="https://t.me/+Bnko8vYkvcRkYjdk")]]
        )
        await update.message.reply_text(
            "ğŸ‘‹ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ø§ÙˆÙ„ Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø´Ùˆ:",
            reply_markup=btn
        )
        return

    await update.message.reply_text(
        "ğŸ“± Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„Øª Ø±Ùˆ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø¨Ø²Ù†:",
        reply_markup=ReplyKeyboardMarkup([["Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡"]], resize_keyboard=True)
    )

# ---------------- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ----------------
async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    user_data = context.user_data

    if text == "Ø§Ø±Ø³Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡":
        await update.message.reply_text(
            "âœ… Ø´Ù…Ø§Ø±Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ø­Ø§Ù„Ø§ ÛŒÚ©ÛŒ Ø§Ø² Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:",
            reply_markup=ReplyKeyboardMarkup([
                ["ğŸ“¦ Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ 2018 - 250 ØªÙˆÙ…Ø§Ù†"],
                ["ğŸ“¦ Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ 2025 - 200 ØªÙˆÙ…Ø§Ù†"],
                ["ğŸ“ Ø§Ù¾Ù„ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ - 350 ØªÙˆÙ…Ø§Ù†"]
            ], resize_keyboard=True)
        )

    elif "2018" in text:
        user_data["product"] = "2018"
        await update.message.reply_text(
            f"""ğŸ”» Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº {PRODUCTS['2018']['price']} ØªÙˆÙ…Ø§Ù† Ø±Ùˆ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†:

{CARD_NUMBER}

Ø³Ù¾Ø³ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ùˆ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†."""
        )

    elif "2025" in text:
        user_data["product"] = "2025"
        await update.message.reply_text(
            f"""ğŸ”» Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº {PRODUCTS['2025']['price']} ØªÙˆÙ…Ø§Ù† Ø±Ùˆ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†:

{CARD_NUMBER}

Ø³Ù¾Ø³ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ùˆ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†."""
        )

    elif "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ" in text:
        user_data["product"] = "custom"
        await update.message.reply_text(
            f"""ğŸ”» Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº {PRODUCTS['custom']['price']} ØªÙˆÙ…Ø§Ù† Ø±Ùˆ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†:

{CARD_NUMBER}

Ø³Ù¾Ø³ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ù…Ø´Ø®ØµØ§Øª Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ù¾Ù„â€ŒØ¢ÛŒØ¯ÛŒ Ø±Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†."""
        )

    else:
        msg = f"""ğŸ“© Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² {update.effective_user.full_name} (ID: {update.effective_user.id}):

{text}"""
        await context.bot.send_message(chat_id=ADMIN_ID, text=msg)
        await update.message.reply_text("âœ… Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø§Ø´ÛŒØ¯.")

# ---------------- Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ† ----------------
async def support_response(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_ID:
        return

    if update.message.reply_to_message:
        try:
            first_line = update.message.reply_to_message.text.splitlines()[0]
            user_id = int(first_line.split("ID: ")[-1].replace(")", ""))
            await context.bot.send_message(chat_id=user_id, text=update.message.text)
            await update.message.reply_text("âœ… Ù¾Ø§Ø³Ø® Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
        except Exception as e:
            await update.message.reply_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®: {e}")

# ---------------- Ø§Ø¬Ø±Ø§ ----------------
def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, message_handler))
    app.add_handler(MessageHandler(filters.TEXT & filters.User(ADMIN_ID), support_response))

    app.run_polling()

if __name__ == "__main__":
    main()
